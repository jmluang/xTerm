name: Build Release Bundles

on:
  push:
    branches:
      - main
      - master
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build-bundles:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            target: aarch64-apple-darwin
            artifact_name: xtermius-macos-aarch64
            bundle_dir: src-tauri/target/aarch64-apple-darwin/release/bundle/dmg
            bundle_pattern: "*.dmg"
          - os: macos-13
            target: x86_64-apple-darwin
            artifact_name: xtermius-macos-x86_64
            bundle_dir: src-tauri/target/x86_64-apple-darwin/release/bundle/dmg
            bundle_pattern: "*.dmg"
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: xtermius-windows-x86_64
            bundle_dir: src-tauri/target/x86_64-pc-windows-msvc/release/bundle
            bundle_pattern: "*.msi *.exe"
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install frontend deps
        run: npm ci

      - name: Build Tauri app bundle
        run: npm run tauri build -- --target ${{ matrix.target }}

      - name: Locate bundle files
        id: find_bundles
        shell: bash
        run: |
          set -euo pipefail
          IFS=' ' read -r -a patterns <<< "${{ matrix.bundle_pattern }}"
          files=()
          for pattern in "${patterns[@]}"; do
            while IFS= read -r file; do
              files+=("$file")
            done < <(find "${{ matrix.bundle_dir }}" -name "$pattern" -print)
          done
          if [[ ${#files[@]} -eq 0 ]]; then
            echo "No bundle files found under ${{ matrix.bundle_dir }} matching: ${{ matrix.bundle_pattern }}"
            exit 1
          fi
          {
            echo "bundle_files<<EOF"
            printf '%s\n' "${files[@]}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
          printf 'Found bundle files:\n%s\n' "${files[*]}"

      - name: Upload bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ steps.find_bundles.outputs.bundle_files }}
          if-no-files-found: error

      - name: Publish GitHub Release assets (tags only)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.find_bundles.outputs.bundle_files }}
          generate_release_notes: true
